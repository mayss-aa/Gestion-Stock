{% extends 'basefront.html.twig' %}

{% block title %}Pr√©vision de remplissage{% endblock %}

{% block body %}
<div class="d-flex flex-column justify-content-center align-items-center vh-100 mt-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="text-center mb-4">
                    <h2 class="fw-bold text-primary">üì¶ Pr√©vision du remplissage du d√©p√¥t</h2>
                    <hr class="w-50 mx-auto">
                </div>

                <div class="card shadow-lg rounded-4 border-primary animate__animated animate__fadeIn">
                    <div class="card-body text-center py-4">
                        {% if capacite_depot == utilisation_actuelle %}
                            <h4 class="text-success fw-bold"><i class="fas fa-check-circle"></i> D√©p√¥t Plein</h4>
                            <p class="mb-3">üèÜ <span class="badge bg-success">Aucun remplissage n√©cessaire</span></p>

                        {% elseif taux_augmentation == 0 and utilisation_actuelle == 0 %}
                            <h4 class="text-warning fw-bold"><i class="fas fa-exclamation-triangle"></i> D√©p√¥t Vide</h4>
                            <p class="mb-3">‚ö†Ô∏è <span class="badge bg-warning text-dark">Aucune donn√©e en stock</span></p>

                        {% elseif prevision is defined and prevision is not null and prevision is not same as(false) %}
                            {% set jours = (prevision is defined and prevision > 0) ? (prevision|round(0, 'floor')) : 'Inconnu' %}
                            <h4 class="text-info fw-bold"><i class="fas fa-clock"></i> Pr√©vision</h4>
                            <p class="mb-3">‚úÖ <span class="badge bg-info text-dark">Remplissage en <strong>{{ jours }}</strong> jour(s)</span></p>

                        {% else %}
                            <h4 class="text-danger fw-bold"><i class="fas fa-times-circle"></i> Erreur</h4>
                            <p class="mb-3">‚ùå <span class="badge bg-danger">Valeur invalide retourn√©e</span></p>
                        {% endif %}

                        {% if capacite_depot is not defined or utilisation_actuelle is not defined or taux_augmentation is not defined %}
                            <p class="text-secondary mt-3">‚ö†Ô∏è <span class="badge bg-secondary">Donn√©es insuffisantes</span></p>
                        {% endif %}

                        <!-- Bouton pour afficher le graphe -->
                        {% if dates is defined and dates is not empty and tauxRemplissage is defined and tauxRemplissage is not empty %}
                            <button class="btn btn-outline-primary btn-sm rounded-pill mt-3 px-4 shadow-sm"
                                onclick="toggleGraph()" style="transition: 0.3s ease-in-out;">
                                üìä Voir les statistiques
                            </button>
                        {% else %}
                            <p class="text-secondary mt-3"><i class="fas fa-info-circle"></i> Aucune statistique disponible pour ce d√©p√¥t.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Graphique -->
        <div id="graphSection" class="mt-3 text-center" style="display: none;">
            <div class="card shadow-lg border-primary rounded-4 animate__animated animate__fadeIn">
                <div class="card-body">
                    <h4 class="text-center text-primary fw-bold">üìä Statistiques du d√©p√¥t</h4>
                    <canvas id="stockChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ajout de Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Script pour afficher/masquer le graphique et r√©cup√©rer les donn√©es dynamiques -->
<script>
    function toggleGraph() {
        let graphSection = document.getElementById("graphSection");
        graphSection.style.display = (graphSection.style.display === "none") ? "block" : "none";
        if (graphSection.style.display === "block") {
            renderChart();
        }
    }

    function renderChart() {
        let ctx = document.getElementById('stockChart').getContext('2d');

        // R√©cup√©rer les donn√©es dynamiques envoy√©es depuis Twig
        let labels = {{ dates is defined and dates is not empty ? dates | json_encode | raw : '[]' }};
        let data = {{ tauxRemplissage is defined and tauxRemplissage is not empty ? tauxRemplissage | json_encode | raw : '[]' }};

        // V√©rifier si un graphique existe d√©j√† et le d√©truire avant d'en cr√©er un nouveau
        if (window.myChart instanceof Chart) {
            window.myChart.destroy();
        }

        if (labels.length === 0 || data.length === 0) {
            console.warn("Aucune donn√©e de statistiques disponible pour ce d√©p√¥t.");
            return;
        }

        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels, 
                datasets: [{
                    label: "Taux de remplissage (%)",
                    data: data,
                    borderColor: "rgba(54, 162, 235, 1)",
                    backgroundColor: "rgba(54, 162, 235, 0.2)",
                    borderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: Math.max(...data) + 10, // Ajuste l'axe Y dynamiquement
                        title: {
                            display: true,
                            text: "Remplissage (%)"
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: "Date"
                        }
                    }
                }
            }
        });
    }
</script>

<!-- Ajout d'animations CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
{% endblock %}
